// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DictionaryEntry {
  id                String   @id @default(cuid())
  word              String   @unique // Unik: Satu kata, satu entry
  meaning           String
  
  // Rich Data
  contextUsage      String   @db.Text 
  nuanceComparison  String   @db.Text 
  synonyms          String[]
  
  // Flags
  isTypo            Boolean  @default(false)
  isMisconception   Boolean  @default(false)
  errorAnalysis     String?  @db.Text
  
  category          String? 
  literalMeaning    String?
  figurativeMeaning String?

  // Relasi: Satu kata bisa menjadi Flashcard (User Progress)
  flashcard         Flashcard? 

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([word])
}

model Flashcard {
  id                String   @id @default(cuid())
  dictionaryEntryId String   @unique // Satu kata hanya punya 1 kartu aktif
  dictionaryEntry   DictionaryEntry @relation(fields: [dictionaryEntryId], references: [id], onDelete: Cascade)

  
  sourceContext     String?  @db.Text 
  sourceType        String   // 'STORY', 'DICTIONARY', 'MANUAL'

  status            String   @default("NEW") // 'NEW', 'LEARNING', 'REVIEWING', 'MASTERED'
  masteryLevel      Int      @default(0)     // 0-5
  nextReviewDate    DateTime? 
  lastReviewedAt    DateTime?

  // ðŸ”¥ NEW: Relasi ke progress log
  progressLogs      FlashcardProgressLog[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([nextReviewDate])
}

// --- NEW CORE: STORY LAB LOGS (Decoupled) ---
model StoryAttempt {
  id              String   @id @default(cuid())
  englishText     String   @db.Text
  userTranslation String   @db.Text
  aiFeedback      String   @db.Text
  score           Int
  createdAt       DateTime @default(now())

  @@index([createdAt])
}

model History {
  id        String   @id @default(cuid())
  feature   String   
  details   String   
  source    String   
  tokens    Int      @default(0)
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model DailyProgress {
  id        String   @id @default(cuid())
  date      String   @unique 
  targets   String[] 
  memorized String[] 
  completed String[] 
  meanings  Json     @default("{}") 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

model Story {
  id        Int      @id @default(autoincrement())
  english   String
  source    String   
  createdAt DateTime @default(now())
}

model GrammarQuestion {
  id           String   @id @default(cuid())
  question     String
  options      String[] 
  correctIndex Int
  explanation  String
  difficulty   String   
  createdAt    DateTime @default(now())

  @@index([difficulty])
}

// ============================================
// ðŸ”¥ NEW: PROGRESS TEMPORAL MODELS
// ============================================

/// Log setiap transisi status flashcard untuk tracking progress
model FlashcardProgressLog {
  id          String    @id @default(cuid())
  flashcardId String
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  
  /// Status sebelum transisi (null jika kartu baru dibuat)
  fromStatus  String?   // 'NEW', 'LEARNING', 'REVIEWING', 'MASTERED'
  /// Status setelah transisi
  toStatus    String    // 'NEW', 'LEARNING', 'REVIEWING', 'MASTERED'
  
  /// Level mastery sebelum transisi
  fromLevel   Int       @default(0)
  /// Level mastery setelah transisi
  toLevel     Int       @default(0)
  
  /// Trigger yang menyebabkan transisi
  trigger     String    @default("REVIEW") // 'REVIEW', 'CREATE', 'RESET'
  
  createdAt   DateTime  @default(now())

  @@index([createdAt])
  @@index([flashcardId])
}

/// Snapshot progres bulanan untuk query cepat
model MonthlySnapshot {
  id                  String   @id @default(cuid())
  month               Int      // 0-11 (JavaScript Date standard)
  year                Int
  
  // === Vocabulary Metrics ===
  wordsAdded          Int      @default(0)  // DictionaryEntry baru
  cardsCreated        Int      @default(0)  // Flashcard baru
  cardsMastered       Int      @default(0)  // Transisi ke MASTERED
  cardsReviewed       Int      @default(0)  // Total review sessions
  
  // === Story Lab Metrics ===
  storyAttempts       Int      @default(0)  // Total story attempts
  storyAvgScore       Float    @default(0)  // Rata-rata skor
  storyBestScore      Int      @default(0)  // Skor tertinggi
  
  // === AI Usage Metrics ===
  tokensUsed          Int      @default(0)  // Total token AI
  aiRequests          Int      @default(0)  // Total request ke AI
  
  // === Daily Challenge Metrics ===
  challengesCompleted Int      @default(0)  // Tantangan harian selesai
  survivalPassed      Int      @default(0)  // Survival mode passed
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([month, year])
  @@index([year, month])
}