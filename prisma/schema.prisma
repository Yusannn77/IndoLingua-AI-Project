// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DictionaryEntry {
  id                String   @id @default(cuid())
  word              String   @unique // Unik: Satu kata, satu entry
  meaning           String
  
  // Rich Data
  contextUsage      String   @db.Text 
  nuanceComparison  String   @db.Text 
  synonyms          String[]
  
  // Flags
  isTypo            Boolean  @default(false)
  isMisconception   Boolean  @default(false)
  errorAnalysis     String?  @db.Text
  
  category          String? 
  literalMeaning    String?
  figurativeMeaning String?

  // Relasi: Satu kata bisa menjadi Flashcard (User Progress)
  flashcard         Flashcard? 

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([word])
}

model Flashcard {
  id                String   @id @default(cuid())
  dictionaryEntryId String   @unique // Satu kata hanya punya 1 kartu aktif
  dictionaryEntry   DictionaryEntry @relation(fields: [dictionaryEntryId], references: [id], onDelete: Cascade)

  
  sourceContext     String?  @db.Text 
  sourceType        String   // 'STORY', 'DICTIONARY', 'MANUAL'

  status            String   @default("NEW") // 'NEW', 'LEARNING', 'REVIEWING', 'MASTERED'
  masteryLevel      Int      @default(0)     // 0-5
  nextReviewDate    DateTime? 
  lastReviewedAt    DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([nextReviewDate])
}

// --- NEW CORE: STORY LAB LOGS (Decoupled) ---
model StoryAttempt {
  id              String   @id @default(cuid())
  englishText     String   @db.Text
  userTranslation String   @db.Text
  aiFeedback      String   @db.Text
  score           Int
  createdAt       DateTime @default(now())

  @@index([createdAt])
}

model History {
  id        String   @id @default(cuid())
  feature   String   
  details   String   
  source    String   
  tokens    Int      @default(0)
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model DailyProgress {
  id        String   @id @default(cuid())
  date      String   @unique 
  targets   String[] 
  memorized String[] 
  completed String[] 
  meanings  Json     @default("{}") 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

model Story {
  id        Int      @id @default(autoincrement())
  english   String
  source    String   
  createdAt DateTime @default(now())
}

model GrammarQuestion {
  id           String   @id @default(cuid())
  question     String
  options      String[] 
  correctIndex Int
  explanation  String
  difficulty   String   
  createdAt    DateTime @default(now())

  @@index([difficulty])
}